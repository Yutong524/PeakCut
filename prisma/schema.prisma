generator client { 
  provider = "prisma-client-js" 
}
datasource db    { 
  provider = "sqlite"
  url = env("DATABASE_URL") 
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  createdAt DateTime @default(now())
  jobs   Job[]   @relation("UserJobs")
  videos Video[]
}

model Video {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  original   String
  durationMs Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])

  jobs     Job[]               @relation("VideoJobs")
  segments SubtitleSegment[]
  editorState EditorState?
}

enum JobType {
  TRANSCRIBE
  AUTOCUT
  TRANSLATE
  RENDER
}

enum JobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

model Job {
  id        String    @id @default(cuid())
  type      JobType
  status    JobStatus @default(QUEUED)
  progress  Int       @default(0)
  error     String?
  userId String?
  user   User?  @relation("UserJobs", fields: [userId], references: [id])

  videoId String
  video   Video  @relation("VideoJobs", fields: [videoId], references: [id])

  metaJson  Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  logText   String? 
  heartbeatAt  DateTime? 
}

model SubtitleSegment {
  id        String   @id @default(cuid())

  videoId String
  video   Video  @relation(fields: [videoId], references: [id])

  startMs   Int
  endMs     Int
  textSrc   String
  textZh    String?
  textEn    String?
  speaker   String?
  createdAt DateTime @default(now())
}

model Project {
  id           String         @id @default(cuid())
  name         String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  videos       Video[]
  editorStates EditorState[]
}

model EditorState {
  id              String    @id @default(cuid())
  videoId         String    @unique
  projectId       String?
  currentMs       Int       @default(0)
  durationMs      Int?
  activeSegmentId String?
  metaJson        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  video   Video   @relation(fields: [videoId], references: [id])
  project Project? @relation(fields: [projectId], references: [id])
}
